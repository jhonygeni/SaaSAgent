<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste: Corre√ß√£o de Status do Agente</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .status-ativo { background-color: #10b981; color: white; }
        .status-inativo { background-color: #ef4444; color: white; }
        .status-pendente { background-color: #f59e0b; color: white; }
        .test-section {
            border: 1px solid #e5e5e5;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
        }
        .success { border-color: #10b981; background-color: #f0fdf4; }
        .error { border-color: #ef4444; background-color: #fef2f2; }
        .info { border-color: #3b82f6; background-color: #eff6ff; }
        .warning { border-color: #f59e0b; background-color: #fffbeb; }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .log {
            max-height: 300px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #e5e5e5;
            padding: 10px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste: Corre√ß√£o de Status do Agente</h1>
        <p><strong>Objetivo:</strong> Validar que agentes n√£o ficam mais como "pendente" ap√≥s cria√ß√£o da inst√¢ncia WhatsApp</p>
        
        <div class="test-section info">
            <h3>üìã Resumo da Corre√ß√£o Aplicada</h3>
            <ul>
                <li>‚úÖ Removida l√≥gica que for√ßava status "pendente" baseado no status da inst√¢ncia WhatsApp</li>
                <li>‚úÖ Status do agente agora √© independente do status da conex√£o WhatsApp</li>
                <li>‚úÖ Baseado apenas no campo <code>status</code> do banco de dados</li>
                <li>‚úÖ Coment√°rio explicativo adicionado no c√≥digo</li>
            </ul>
        </div>

        <div class="test-section">
            <h3>üîç Teste de Valida√ß√£o</h3>
            <button onclick="testAgentStatusLogic()">Testar L√≥gica de Status</button>
            <button onclick="simulateAgentCreation()">Simular Cria√ß√£o de Agente</button>
            <button onclick="simulateWhatsAppFailure()">Simular Falha de WhatsApp</button>
            <button onclick="clearLog()">Limpar Log</button>
            
            <div id="testResults" class="log"></div>
        </div>

        <div class="test-section">
            <h3>üìä Cen√°rios de Teste</h3>
            <div id="testScenarios"></div>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            const logDiv = document.getElementById('testResults');
            logDiv.innerHTML += `<div style="color: ${getLogColor(type)}">[${timestamp}] ${prefix} ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function getLogColor(type) {
            switch(type) {
                case 'success': return '#10b981';
                case 'error': return '#ef4444';
                case 'warning': return '#f59e0b';
                default: return '#e5e5e5';
            }
        }

        function clearLog() {
            document.getElementById('testResults').innerHTML = '';
        }

        // Simula a fun√ß√£o convertDbAgentToAppAgent corrigida
        function convertDbAgentToAppAgent(dbAgent) {
            // Parse settings
            let settings = {};
            try {
                settings = dbAgent.settings ? 
                    (typeof dbAgent.settings === 'string' ? 
                        JSON.parse(dbAgent.settings) : dbAgent.settings) : {};
            } catch (e) {
                console.error("Error parsing agent settings:", e);
                settings = {};
            }

            // Map database status to Agent status type based on is_active field only
            let status = "pendente";
            if (dbAgent.status === "ativo") status = "ativo";
            else if (dbAgent.status === "inativo") status = "inativo";
            
            // Note: Agent status is independent of WhatsApp connection status
            // CORRE√á√ÉO: Removida a l√≥gica problem√°tica que verificava instanceStatus
            
            return {
                id: dbAgent.id,
                nome: settings.name || "",
                status: status,
                connected: !!settings.connected,
                instanceName: dbAgent.instance_name
            };
        }

        function testAgentStatusLogic() {
            log('üî¨ Iniciando teste da l√≥gica de status...', 'info');

            // Cen√°rio 1: Agente ativo com WhatsApp pendente
            const dbAgent1 = {
                id: 'test-1',
                status: 'ativo',
                instance_name: 'test-instance-1',
                settings: JSON.stringify({
                    name: 'Agente Teste 1',
                    connected: false
                }),
                whatsapp_instances: {
                    status: 'pending' // WhatsApp ainda pendente
                }
            };

            const agent1 = convertDbAgentToAppAgent(dbAgent1);
            
            if (agent1.status === 'ativo') {
                log('‚úÖ CORRE√á√ÉO FUNCIONANDO: Agente mant√©m status "ativo" mesmo com WhatsApp pendente', 'success');
            } else {
                log(`‚ùå ERRO: Agente deveria ser "ativo" mas retornou "${agent1.status}"`, 'error');
            }

            // Cen√°rio 2: Agente inativo independente do WhatsApp
            const dbAgent2 = {
                id: 'test-2',
                status: 'inativo',
                instance_name: 'test-instance-2',
                settings: JSON.stringify({
                    name: 'Agente Teste 2',
                    connected: true
                }),
                whatsapp_instances: {
                    status: 'connected' // WhatsApp conectado
                }
            };

            const agent2 = convertDbAgentToAppAgent(dbAgent2);
            
            if (agent2.status === 'inativo') {
                log('‚úÖ CORRE√á√ÉO FUNCIONANDO: Agente mant√©m status "inativo" independente do WhatsApp', 'success');
            } else {
                log(`‚ùå ERRO: Agente deveria ser "inativo" mas retornou "${agent2.status}"`, 'error');
            }

            // Cen√°rio 3: Agente pendente (padr√£o)
            const dbAgent3 = {
                id: 'test-3',
                status: 'pendente',
                instance_name: 'test-instance-3',
                settings: JSON.stringify({
                    name: 'Agente Teste 3',
                    connected: false
                })
            };

            const agent3 = convertDbAgentToAppAgent(dbAgent3);
            
            if (agent3.status === 'pendente') {
                log('‚úÖ CORRE√á√ÉO FUNCIONANDO: Agente mant√©m status "pendente" quando definido explicitamente', 'success');
            } else {
                log(`‚ùå ERRO: Agente deveria ser "pendente" mas retornou "${agent3.status}"`, 'error');
            }

            log('üèÅ Teste da l√≥gica de status conclu√≠do', 'info');
        }

        function simulateAgentCreation() {
            log('üöÄ Simulando cria√ß√£o de agente...', 'info');
            
            // Simula o fluxo de cria√ß√£o
            setTimeout(() => {
                log('üìù Agente salvo no banco com status: "ativo"', 'info');
                
                setTimeout(() => {
                    log('üì± Iniciando cria√ß√£o da inst√¢ncia WhatsApp...', 'info');
                    
                    setTimeout(() => {
                        log('‚è±Ô∏è Webhook timeout (8000ms) - mas agente j√° foi salvo!', 'warning');
                        log('‚úÖ RESULTADO: Agente permanece vis√≠vel no dashboard com status "ativo"', 'success');
                        log('üéâ PROBLEMA RESOLVIDO: Agente n√£o desaparece mais!', 'success');
                    }, 1000);
                }, 500);
            }, 500);
        }

        function simulateWhatsAppFailure() {
            log('üí• Simulando falha de conex√£o WhatsApp...', 'warning');
            
            setTimeout(() => {
                log('‚ùå Inst√¢ncia WhatsApp falhou ao conectar', 'error');
                log('‚úÖ CORRE√á√ÉO: Status do agente permanece inalterado', 'success');
                log('üìä Agente continua vis√≠vel no dashboard', 'success');
                log('üîÑ Usu√°rio pode tentar reconectar WhatsApp sem perder o agente', 'info');
            }, 1000);
        }

        // Renderizar cen√°rios de teste
        function renderTestScenarios() {
            const scenarios = [
                {
                    title: "‚úÖ Agente Ativo + WhatsApp Pendente",
                    description: "Agente deve permanecer ativo independente do status WhatsApp",
                    status: "success"
                },
                {
                    title: "‚úÖ Agente Inativo + WhatsApp Conectado", 
                    description: "Status do agente n√£o deve ser afetado pela conex√£o WhatsApp",
                    status: "success"
                },
                {
                    title: "‚úÖ Webhook Timeout",
                    description: "Agente deve permanecer vis√≠vel mesmo com falha de webhook",
                    status: "success"
                },
                {
                    title: "‚úÖ Refresh da P√°gina",
                    description: "Agentes devem permanecer vis√≠veis ap√≥s atualiza√ß√£o",
                    status: "success"
                }
            ];

            const container = document.getElementById('testScenarios');
            container.innerHTML = scenarios.map(scenario => `
                <div class="test-section ${scenario.status}">
                    <h4>${scenario.title}</h4>
                    <p>${scenario.description}</p>
                </div>
            `).join('');
        }

        // Inicializar p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            renderTestScenarios();
            log('üîß P√°gina de teste carregada - Corre√ß√£o aplicada em agentService.ts', 'info');
            log('üìã Execute os testes para validar a corre√ß√£o', 'info');
        });
    </script>
</body>
</html>
