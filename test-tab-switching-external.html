<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste Espec√≠fico - Troca de Abas Externa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        .alert {
            background: rgba(255,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #ff4444;
            font-weight: bold;
            font-size: 18px;
        }
        
        .success {
            background: rgba(0,255,0,0.8);
            border-left-color: #44ff44;
        }
        
        .warning {
            background: rgba(255,165,0,0.8);
            border-left-color: #ffaa44;
        }
        
        .info {
            background: rgba(0,123,255,0.8);
            border-left-color: #4488ff;
        }
        
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        button {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        button.primary {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }
        
        button.success {
            background: linear-gradient(45deg, #56ab2f, #a8e6cf);
        }
        
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #ffeb3b;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .metric-label {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }
        
        .dashboard-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            background: white;
        }
        
        .log-container {
            background: rgba(0,0,0,0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 5px;
            background: rgba(255,255,255,0.1);
        }
        
        .log-critical {
            background: rgba(255,0,0,0.3);
            border-left: 4px solid #ff4444;
        }
        
        .log-warning {
            background: rgba(255,165,0,0.3);
            border-left: 4px solid #ffaa44;
        }
        
        .log-success {
            background: rgba(0,255,0,0.3);
            border-left: 4px solid #44ff44;
        }
        
        .log-info {
            background: rgba(0,123,255,0.3);
            border-left: 4px solid #4488ff;
        }
        
        .instructions {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid #ffeb3b;
        }
        
        .step {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .step-number {
            background: #ffeb3b;
            color: #333;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Teste Espec√≠fico - Problema de Recarregamento ao Trocar de Aba</h1>
        
        <div class="alert info">
            <strong>üéØ OBJETIVO:</strong> Este teste replica exatamente o problema relatado: 
            recarregamento do dashboard quando voc√™ sai da aba e volta a entrar.
        </div>
        
        <div class="instructions">
            <h3>üìã Instru√ß√µes do Teste:</h3>
            
            <div class="step">
                <span class="step-number">1</span>
                <strong>Carregue o dashboard</strong> clicando no bot√£o "üöÄ Carregar Dashboard"
            </div>
            
            <div class="step">
                <span class="step-number">2</span>
                <strong>Aguarde o dashboard carregar completamente</strong> (voc√™ ver√° a tela de login ou dashboard)
            </div>
            
            <div class="step">
                <span class="step-number">3</span>
                <strong>Abra uma nova aba ou mude para outra aba</strong> e permane√ßa l√° por alguns segundos
            </div>
            
            <div class="step">
                <span class="step-number">4</span>
                <strong>Volte para esta aba</strong> e observe se o dashboard foi recarregado
            </div>
            
            <div class="step">
                <span class="step-number">5</span>
                <strong>Observe os logs</strong> para identificar exatamente o que est√° causando o problema
            </div>
        </div>
        
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="reload-count">0</div>
                <div class="metric-label">Recarregamentos Detectados</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="visibility-changes">0</div>
                <div class="metric-label">Mudan√ßas de Visibilidade</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="fetch-requests">0</div>
                <div class="metric-label">Requisi√ß√µes HTTP</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="memory-usage">--</div>
                <div class="metric-label">Uso de Mem√≥ria (MB)</div>
            </div>
        </div>
        
        <div class="test-controls">
            <button class="primary" onclick="loadDashboard()">üöÄ Carregar Dashboard</button>
            <button onclick="simulateTabSwitch()">üîÑ Simular Troca de Aba</button>
            <button onclick="checkDashboardStatus()">üîç Verificar Status</button>
            <button class="success" onclick="clearLogs()">üßπ Limpar Logs</button>
        </div>
        
        <div class="log-container" id="log-container">
            <div class="log-entry log-info">üöÄ Sistema de monitoramento iniciado. Esperando a√ß√µes do usu√°rio...</div>
        </div>
        
        <h3>üñ•Ô∏è Dashboard em Teste:</h3>
        <iframe id="dashboard-frame" class="dashboard-frame" src="about:blank"></iframe>
    </div>

    <script>
        let reloadCount = 0;
        let visibilityChanges = 0;
        let fetchRequests = 0;
        let isMonitoring = false;
        let dashboardLoaded = false;
        let lastVisibilityTime = Date.now();
        
        function log(message, type = 'info') {
            const container = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
            
            // Log no console tamb√©m para debug
            console.log(`[TAB_SWITCH_TEST] ${message}`);
        }
        
        function updateMetric(id, value) {
            document.getElementById(id).textContent = value;
        }
        
        function updateMemoryUsage() {
            if (performance.memory) {
                const usedMB = Math.round(performance.memory.usedJSHeapSize / 1024 / 1024);
                updateMetric('memory-usage', usedMB);
            }
        }
        
        function loadDashboard() {
            log('üîÑ Carregando dashboard no iframe...', 'info');
            
            const iframe = document.getElementById('dashboard-frame');
            iframe.src = 'http://localhost:8081';
            
            iframe.onload = function() {
                log('‚úÖ Dashboard carregado com sucesso!', 'success');
                dashboardLoaded = true;
                
                if (!isMonitoring) {
                    startMonitoring();
                }
                
                // Verificar se h√° elementos do React carregados
                //DISABLED setTimeout(() => {
                    try {
                        if (iframe.contentWindow) {
                            log('üîç Dashboard ativo e responsivo', 'success');
                        }
                    } catch (e) {
                        log('‚ö†Ô∏è N√£o foi poss√≠vel acessar conte√∫do do iframe (normal para dom√≠nios diferentes)', 'warning');
                    }
                }, 1000);
            };
            
            iframe.onerror = function() {
                log('‚ùå Erro ao carregar o dashboard', 'critical');
                dashboardLoaded = false;
            };
        }
        
        function startMonitoring() {
            if (isMonitoring) return;
            isMonitoring = true;
            
            log('üõ°Ô∏è Iniciando monitoramento de eventos...', 'info');
            
            // MONITOR: Mudan√ßas de visibilidade da p√°gina
            document.addEventListener('//DISABLED visibilitychange', function() {
                const now = Date.now();
                const timeSinceLastChange = now - lastVisibilityTime;
                lastVisibilityTime = now;
                
                visibilityChanges++;
                updateMetric('visibility-changes', visibilityChanges);
                
                if (document.hidden) {
                    log('üëÅÔ∏è P√°gina ficou OCULTA (usu√°rio mudou de aba)', 'warning');
                } else {
                    log('üëÅÔ∏è P√°gina ficou VIS√çVEL (usu√°rio voltou √† aba)', 'info');
                    
                    // AQUI √â ONDE O PROBLEMA PODE ACONTECER!
                    //DISABLED setTimeout(() => {
                        checkForReload(timeSinceLastChange);
                    }, 500);
                }
            });
            
            // MONITOR: Focus/Blur da janela
            window.addEventListener('focus', function() {
                log('üéØ Janela recebeu FOCUS', 'info');
                //DISABLED setTimeout(checkDashboardStatus, 300);
            });
            
            window.addEventListener('blur', function() {
                log('üò¥ Janela perdeu FOCUS', 'warning');
            });
            
            // MONITOR: Interceptar fetch requests do iframe
            monitorNetworkRequests();
            
            // MONITOR: Mem√≥ria a cada 5 segundos
            //DISABLED setInterval(updateMemoryUsage, 5000);
        }
        
        function checkForReload(timeSinceLastChange) {
            const iframe = document.getElementById('dashboard-frame');
            
            if (!dashboardLoaded || !iframe.src || iframe.src === 'about:blank') {
                return;
            }
            
            // Verificar se o iframe foi recarregado
            try {
                // Se conseguimos acessar, provavelmente n√£o recarregou
                const currentSrc = iframe.src;
                log(`üîç Verificando status do dashboard: ${currentSrc}`, 'info');
                
                // Verificar sinais de recarregamento
                if (timeSinceLastChange < 100) {
                    reloadCount++;
                    updateMetric('reload-count', reloadCount);
                    log('üö® RECARREGAMENTO DETECTADO! Dashboard foi recarregado ap√≥s voltar √† aba', 'critical');
                    
                    // Logs detalhados para debug
                    log(`‚è±Ô∏è Tempo desde √∫ltima mudan√ßa: ${timeSinceLastChange}ms`, 'critical');
                    log('üîç Verificando poss√≠veis causas...', 'critical');
                    
                    // Verificar console errors
                    //DISABLED setTimeout(() => {
                        log('üìä Para mais detalhes, abra DevTools > Console e procure por erros', 'info');
                    }, 1000);
                }
                
            } catch (e) {
                log(`‚ö†Ô∏è Erro ao verificar iframe: ${e.message}`, 'warning');
            }
        }
        
        function monitorNetworkRequests() {
            // Interceptar fetch do iframe seria ideal, mas por limita√ß√µes de CORS,
            // vamos monitorar pelo Performance API
            const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                    if (entry.name.includes('localhost:8081')) {
                        fetchRequests++;
                        updateMetric('fetch-requests', fetchRequests);
                        log(`üì° Requisi√ß√£o detectada: ${entry.name}`, 'info');
                    }
                }
            });
            
            try {
                observer.observe({entryTypes: ['resource']});
            } catch (e) {
                log('‚ö†Ô∏è Performance Observer n√£o suportado completamente', 'warning');
            }
        }
        
        function simulateTabSwitch() {
            log('üß™ SIMULANDO troca de aba...', 'warning');
            
            // Simular perda de foco
            window.dispatchEvent(new Event('blur'));
            
            // Simular mudan√ßa de visibilidade
            Object.defineProperty(document, 'hidden', {
                writable: true,
                value: true
            });
            document.dispatchEvent(new Event('//DISABLED visibilitychange'));
            
            //DISABLED setTimeout(() => {
                // Simular volta do foco
                Object.defineProperty(document, 'hidden', {
                    writable: true,
                    value: false
                });
                document.dispatchEvent(new Event('//DISABLED visibilitychange'));
                window.dispatchEvent(new Event('focus'));
                
                log('‚úÖ Simula√ß√£o de troca de aba conclu√≠da', 'success');
            }, 3000);
        }
        
        function checkDashboardStatus() {
            const iframe = document.getElementById('dashboard-frame');
            
            if (!iframe.src || iframe.src === 'about:blank') {
                log('‚ö†Ô∏è Dashboard n√£o carregado', 'warning');
                return;
            }
            
            log(`üîç Status do dashboard: ${iframe.src}`, 'info');
            log(`üìä Tamanho do iframe: ${iframe.offsetWidth}x${iframe.offsetHeight}`, 'info');
            
            try {
                if (iframe.contentWindow) {
                    log('‚úÖ Iframe ativo e responsivo', 'success');
                }
            } catch (e) {
                log('üîí Acesso ao conte√∫do do iframe bloqueado (normal)', 'info');
            }
            
            updateMemoryUsage();
        }
        
        function clearLogs() {
            document.getElementById('log-container').innerHTML = 
                '<div class="log-entry log-info">üßπ Logs limpos. Continuando monitoramento...</div>';
        }
        
        // Inicializa√ß√£o
        log('üöÄ Teste de troca de abas iniciado', 'success');
        log('üìã Siga as instru√ß√µes acima para reproduzir o problema', 'info');
        
        // Verificar se servidor est√° rodando
        fetch('http://localhost:8081')
            .then(() => {
                log('‚úÖ Servidor de desenvolvimento detectado na porta 8081', 'success');
            })
            .catch(() => {
                log('‚ùå Servidor n√£o encontrado. Execute "npm run dev" primeiro!', 'critical');
            });
    </script>
</body>
</html>
