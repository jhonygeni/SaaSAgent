<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Dashboard Agents</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .section { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        .info { background: #d1ecf1; border-color: #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f8f9fa; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Test Dashboard - Verifica√ß√£o de Agentes</h1>
        
        <div class="section info">
            <h3>Status</h3>
            <p id="status">Verificando estado do dashboard...</p>
        </div>

        <div class="section">
            <h3>A√ß√µes de Teste</h3>
            <button class="btn-primary" onclick="checkUserAuth()">1. Verificar Autentica√ß√£o</button>
            <button class="btn-primary" onclick="checkDatabaseAgents()">2. Verificar Agentes no BD</button>
            <button class="btn-primary" onclick="testAgentContext()">3. Simular AgentContext</button>
            <button class="btn-success" onclick="createTestAgent()">4. Criar Agente de Teste</button>
            <button class="btn-danger" onclick="clearTestData()">5. Limpar Dados de Teste</button>
        </div>

        <div class="section">
            <h3>Resultados</h3>
            <div id="results"></div>
        </div>

        <div class="section">
            <h3>Logs</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2.38.4';

        const supabaseUrl = 'https://fdzhhdmxhzsrfbtqmwip.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkemhoZG14aHpzcmZidHFtd2lwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE1ODYxNTAsImV4cCI6MjA0NzE2MjE1MH0.7QON3_zSNGF5oOTU1Pzo1nRCFZ-YxnKCTSXasDz2aOY';
        
        const supabase = createClient(supabaseUrl, supabaseKey);

        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logs.innerHTML += `<div class="section ${logClass}"><strong>[${timestamp}]</strong> ${message}</div>`;
            console.log(`[${timestamp}] ${message}`);
        }

        function updateResults(content) {
            document.getElementById('results').innerHTML = content;
        }

        function updateStatus(message) {
            document.getElementById('status').textContent = message;
        }

        async function checkUserAuth() {
            log('üîê Verificando autentica√ß√£o do usu√°rio...');
            try {
                const { data: { user }, error } = await supabase.auth.getUser();
                
                if (error) {
                    log(`‚ùå Erro de auth: ${error.message}`, 'error');
                    updateResults('<p class="error">Usu√°rio n√£o autenticado</p>');
                    return null;
                }

                if (!user) {
                    log('‚ö†Ô∏è Usu√°rio n√£o encontrado', 'warning');
                    updateResults('<p class="warning">Usu√°rio n√£o encontrado - Fa√ßa login no app principal</p>');
                    return null;
                }

                log(`‚úÖ Usu√°rio autenticado: ${user.email}`, 'success');
                updateResults(`
                    <div class="success">
                        <h4>‚úÖ Usu√°rio Autenticado</h4>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Criado em:</strong> ${new Date(user.created_at).toLocaleString()}</p>
                    </div>
                `);
                return user;
            } catch (error) {
                log(`‚ùå Exce√ß√£o na auth: ${error.message}`, 'error');
                updateResults(`<p class="error">Erro de conex√£o: ${error.message}</p>`);
                return null;
            }
        }

        async function checkDatabaseAgents() {
            log('üîç Verificando agentes no banco de dados...');
            try {
                const user = await checkUserAuth();
                if (!user) return;

                const { data, error, count } = await supabase
                    .from('agents')
                    .select('*', { count: 'exact' })
                    .eq('user_id', user.id);

                if (error) {
                    log(`‚ùå Erro na query: ${error.message}`, 'error');
                    updateResults(`<p class="error">Erro na consulta: ${error.message}</p>`);
                    return;
                }

                log(`üìä Encontrados ${count || 0} agentes no banco`, 'info');

                if (data && data.length > 0) {
                    let tableHTML = `
                        <div class="success">
                            <h4>‚úÖ Agentes Encontrados (${data.length})</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Nome</th>
                                        <th>Status</th>
                                        <th>Ativo</th>
                                        <th>Criado em</th>
                                        <th>Settings</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.forEach(agent => {
                        const settings = agent.settings || {};
                        const name = settings.name || agent.name || 'N/A';
                        tableHTML += `
                            <tr>
                                <td>${agent.id}</td>
                                <td>${name}</td>
                                <td>${agent.status || 'N/A'}</td>
                                <td>${agent.is_active ? 'Sim' : 'N√£o'}</td>
                                <td>${new Date(agent.created_at).toLocaleString()}</td>
                                <td>${JSON.stringify(settings).substring(0, 100)}...</td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table></div>';
                    updateResults(tableHTML);
                } else {
                    updateResults(`
                        <div class="warning">
                            <h4>‚ö†Ô∏è Nenhum agente encontrado</h4>
                            <p>N√£o existem agentes cadastrados para este usu√°rio.</p>
                            <p>Isso explica por que o dashboard n√£o mostra agentes.</p>
                        </div>
                    `);
                }

                return data;
            } catch (error) {
                log(`‚ùå Exce√ß√£o: ${error.message}`, 'error');
                updateResults(`<p class="error">Exce√ß√£o: ${error.message}</p>`);
            }
        }

        async function testAgentContext() {
            log('üîß Simulando funcionamento do AgentContext...');
            
            function convertDbAgentToAppAgent(dbAgent) {
                try {
                    let settings = {};
                    try {
                        settings = dbAgent.settings ? 
                            (typeof dbAgent.settings === 'string' ? 
                                JSON.parse(dbAgent.settings) : dbAgent.settings) : {};
                    } catch (e) {
                        log(`‚ö†Ô∏è Erro ao parsear settings: ${e.message}`, 'warning');
                        settings = {};
                    }

                    let parsedFaqs = [];
                    try {
                        if (settings.faqs) {
                            parsedFaqs = typeof settings.faqs === 'string' ? 
                                JSON.parse(settings.faqs) : settings.faqs;
                        }
                    } catch (e) {
                        log(`‚ö†Ô∏è Erro ao parsear FAQs: ${e.message}`, 'warning');
                        parsedFaqs = [];
                    }
                    
                    let status = "pendente";
                    if (dbAgent.status === "ativo") status = "ativo";
                    else if (dbAgent.status === "inativo") status = "inativo";

                    const businessSector = 
                        ["Varejo", "Sa√∫de", "Educa√ß√£o", "Finan√ßas", "Servi√ßos", "Imobili√°ria", 
                          "Alimenta√ß√£o", "Tecnologia", "Turismo", "Outro"]
                          .includes(settings.business_sector) 
                            ? settings.business_sector 
                            : "Outro";

                    return {
                        id: dbAgent.id,
                        nome: settings.name || "",
                        site: settings.website || "",
                        areaDeAtuacao: businessSector,
                        informacoes: settings.information || "",
                        prompt: settings.prompt || "",
                        faqs: parsedFaqs,
                        createdAt: dbAgent.created_at,
                        status: status,
                        connected: !!settings.connected,
                        phoneNumber: settings.phone_number || "",
                        messageCount: settings.message_count || 0,
                        messageLimit: settings.message_limit || 100,
                        instanceName: dbAgent.instance_name
                    };
                } catch (error) {
                    log(`‚ùå Erro na convers√£o: ${error.message}`, 'error');
                    return null;
                }
            }

            try {
                const user = await checkUserAuth();
                if (!user) return;

                const { data, error } = await supabase
                    .from('agents')
                    .select('*')
                    .eq('user_id', user.id);

                if (error) {
                    log(`‚ùå Erro: ${error.message}`, 'error');
                    return;
                }

                const convertedAgents = data.map(convertDbAgentToAppAgent).filter(agent => agent !== null);
                
                log(`‚úÖ Convers√£o realizada: ${convertedAgents.length} agentes processados`, 'success');
                
                if (convertedAgents.length > 0) {
                    let agentHTML = `
                        <div class="success">
                            <h4>‚úÖ Agentes Processados (${convertedAgents.length})</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Status</th>
                                        <th>√Årea</th>
                                        <th>Conectado</th>
                                        <th>Site</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    convertedAgents.forEach(agent => {
                        agentHTML += `
                            <tr>
                                <td>${agent.nome || 'N/A'}</td>
                                <td>${agent.status}</td>
                                <td>${agent.areaDeAtuacao}</td>
                                <td>${agent.connected ? 'Sim' : 'N√£o'}</td>
                                <td>${agent.site || 'N/A'}</td>
                            </tr>
                        `;
                    });
                    
                    agentHTML += '</tbody></table></div>';
                    updateResults(agentHTML);
                } else {
                    updateResults('<div class="warning"><h4>‚ö†Ô∏è Nenhum agente v√°lido ap√≥s convers√£o</h4></div>');
                }

                return convertedAgents;
            } catch (error) {
                log(`‚ùå Exce√ß√£o no teste: ${error.message}`, 'error');
            }
        }

        async function createTestAgent() {
            log('üÜï Criando agente de teste...');
            try {
                const user = await checkUserAuth();
                if (!user) return;

                const testAgent = {
                    user_id: user.id,
                    name: 'Agente de Teste',
                    status: 'ativo',
                    is_active: true,
                    settings: {
                        name: 'Agente de Teste Dashboard',
                        website: 'https://teste.com',
                        business_sector: 'Tecnologia',
                        information: 'Agente criado para testar o dashboard',
                        faqs: [
                            { pergunta: 'Como funciona?', resposta: 'Este √© um teste.' }
                        ],
                        connected: false,
                        message_count: 0,
                        message_limit: 100
                    }
                };

                const { data, error } = await supabase
                    .from('agents')
                    .insert(testAgent)
                    .select()
                    .single();

                if (error) {
                    log(`‚ùå Erro ao criar agente: ${error.message}`, 'error');
                    updateResults(`<p class="error">Erro ao criar agente: ${error.message}</p>`);
                    return;
                }

                log(`‚úÖ Agente de teste criado com ID: ${data.id}`, 'success');
                updateResults(`
                    <div class="success">
                        <h4>‚úÖ Agente de Teste Criado</h4>
                        <p><strong>ID:</strong> ${data.id}</p>
                        <p><strong>Nome:</strong> ${testAgent.settings.name}</p>
                        <p>Agora recarregue o dashboard para ver se aparece!</p>
                    </div>
                `);

                // Recheck agents
                //DISABLED setTimeout(() => checkDatabaseAgents(), 1000);
            } catch (error) {
                log(`‚ùå Exce√ß√£o: ${error.message}`, 'error');
            }
        }

        async function clearTestData() {
            log('üóëÔ∏è Limpando dados de teste...');
            try {
                const user = await checkUserAuth();
                if (!user) return;

                const { data, error } = await supabase
                    .from('agents')
                    .delete()
                    .eq('user_id', user.id)
                    .like('name', '%Teste%');

                if (error) {
                    log(`‚ùå Erro ao limpar: ${error.message}`, 'error');
                    return;
                }

                log(`‚úÖ Dados de teste removidos`, 'success');
                updateResults('<div class="success"><h4>‚úÖ Dados de teste removidos</h4></div>');
                
                // Recheck agents
                //DISABLED setTimeout(() => checkDatabaseAgents(), 1000);
            } catch (error) {
                log(`‚ùå Exce√ß√£o: ${error.message}`, 'error');
            }
        }

        // Expor fun√ß√µes globalmente
        window.checkUserAuth = checkUserAuth;
        window.checkDatabaseAgents = checkDatabaseAgents;
        window.testAgentContext = testAgentContext;
        window.createTestAgent = createTestAgent;
        window.clearTestData = clearTestData;

        // Auto-executar verifica√ß√£o inicial
        window.addEventListener('load', async () => {
            updateStatus('Executando verifica√ß√µes autom√°ticas...');
            await checkUserAuth();
            await checkDatabaseAgents();
            updateStatus('Verifica√ß√µes conclu√≠das');
        });
    </script>
</body>
</html>
