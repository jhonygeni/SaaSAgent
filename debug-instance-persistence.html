<!DOCTYPE html>
<html>
<head>
    <title>Teste de Persist√™ncia de Inst√¢ncias WhatsApp</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico de Persist√™ncia de Inst√¢ncias WhatsApp</h1>
    
    <div id="controls">
        <button onclick="testDatabaseConnection()">Testar Conex√£o DB</button>
        <button onclick="testReadInstances()">Ler Inst√¢ncias</button>
        <button onclick="testCreateInstance()">Criar Inst√¢ncia Teste</button>
        <button onclick="testRLSPolicies()">Testar RLS</button>
        <button onclick="runFullDiagnostic()">Diagn√≥stico Completo</button>
        <button onclick="clearLogs()">Limpar Logs</button>
    </div>
    
    <div id="logs"></div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        const supabaseUrl = 'https://hpovwcaskorzzrpphgkc.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhwb3Z3Y2Fza29yenpycHBoZ2tjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc4MjYzODYsImV4cCI6MjA2MzQwMjM4Nn0.3Gx3Gc5xlFKwoMvd0Zk9vELzNbrf0ar4gaM92n9dtDc';
        
        const { createClient } = supabase;
        const client = createClient(supabaseUrl, supabaseKey);
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logs.appendChild(logDiv);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testDatabaseConnection() {
            log('üîç Testando conex√£o com o banco de dados...', 'info');
            
            try {
                const { count, error } = await client
                    .from('whatsapp_instances')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                    log(`Detalhes: ${JSON.stringify(error, null, 2)}`, 'error');
                    return false;
                }
                
                log(`‚úÖ Conex√£o bem-sucedida! Total de registros: ${count}`, 'success');
                return true;
            } catch (error) {
                log(`‚ùå Erro na conex√£o: ${error.message}`, 'error');
                return false;
            }
        }
        
        async function testReadInstances() {
            log('üìã Testando leitura das inst√¢ncias existentes...', 'info');
            
            try {
                const { data: instances, error } = await client
                    .from('whatsapp_instances')
                    .select('*')
                    .limit(10);
                
                if (error) {
                    log(`‚ùå Erro ao ler inst√¢ncias: ${error.message}`, 'error');
                    log(`C√≥digo do erro: ${error.code}`, 'error');
                    log(`Detalhes: ${error.details}`, 'error');
                    return;
                }
                
                log(`‚úÖ Inst√¢ncias encontradas: ${instances.length}`, 'success');
                if (instances.length > 0) {
                    log(`üìä Primeira inst√¢ncia: ${JSON.stringify(instances[0], null, 2)}`, 'info');
                }
                
                return instances;
            } catch (error) {
                log(`‚ùå Erro ao ler inst√¢ncias: ${error.message}`, 'error');
            }
        }
        
        async function testCreateInstance() {
            log('‚úèÔ∏è Testando cria√ß√£o de inst√¢ncia de teste...', 'info');
            
            try {
                const testUserId = '00000000-0000-0000-0000-000000000001';
                const testInstanceName = `test_persistence_${Date.now()}`;
                
                const { data: newInstance, error } = await client
                    .from('whatsapp_instances')
                    .insert({
                        user_id: testUserId,
                        name: testInstanceName,
                        status: 'testing',
                        evolution_instance_id: `test_evo_${Date.now()}`,
                        session_data: {
                            test: true,
                            created_at: new Date().toISOString()
                        }
                    })
                    .select()
                    .single();
                
                if (error) {
                    log(`‚ùå Erro ao criar inst√¢ncia: ${error.message}`, 'error');
                    log(`C√≥digo: ${error.code}`, 'error');
                    log(`Detalhes: ${error.details}`, 'error');
                    log(`Hint: ${error.hint}`, 'error');
                    return null;
                }
                
                log(`‚úÖ Inst√¢ncia criada com sucesso: ${JSON.stringify(newInstance, null, 2)}`, 'success');
                
                // Limpar a inst√¢ncia de teste
                await client
                    .from('whatsapp_instances')
                    .delete()
                    .eq('id', newInstance.id);
                
                log('‚úÖ Inst√¢ncia de teste removida', 'success');
                return newInstance;
            } catch (error) {
                log(`‚ùå Erro ao criar inst√¢ncia: ${error.message}`, 'error');
                return null;
            }
        }
        
        async function testRLSPolicies() {
            log('üîí Testando pol√≠ticas RLS (Row Level Security)...', 'info');
            
            try {
                // Testar sem autentica√ß√£o
                const { data: publicData, error: publicError } = await client
                    .from('whatsapp_instances')
                    .select('*')
                    .limit(1);
                
                if (publicError) {
                    log(`‚ö†Ô∏è Acesso p√∫blico negado (RLS pode estar ativo): ${publicError.message}`, 'warning');
                    return { rlsActive: true, error: publicError };
                } else {
                    log('‚ö†Ô∏è Acesso p√∫blico permitido (RLS pode estar desativado)', 'warning');
                    return { rlsActive: false, data: publicData };
                }
            } catch (error) {
                log(`‚ùå Erro ao testar RLS: ${error.message}`, 'error');
                return { error };
            }
        }
        
        async function runFullDiagnostic() {
            log('üöÄ Iniciando diagn√≥stico completo...', 'info');
            
            const connectionOk = await testDatabaseConnection();
            if (!connectionOk) {
                log('‚ùå Falha na conex√£o b√°sica - interrompendo testes', 'error');
                return;
            }
            
            await testRLSPolicies();
            await testReadInstances();
            await testCreateInstance();
            
            log('üéØ Diagn√≥stico completo conclu√≠do!', 'success');
            log('üìù Pr√≥ximos passos recomendados:', 'info');
            log('1. Verificar se o user_id est√° sendo passado corretamente', 'info');
            log('2. Confirmar se as pol√≠ticas RLS permitem inser√ß√£o/leitura', 'info');
            log('3. Validar se a Evolution API est√° retornando os dados esperados', 'info');
            log('4. Testar a fun√ß√£o createAndConfigureInstance com dados reais', 'info');
        }
        
        // Executar teste inicial
        log('üîß Interface de diagn√≥stico carregada', 'success');
        log('üëÜ Use os bot√µes acima para executar testes espec√≠ficos', 'info');
    </script>
</body>
</html>
