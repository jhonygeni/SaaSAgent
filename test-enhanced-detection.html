<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üß™ Teste de L√≥gica de Detec√ß√£o - Evolution API v2</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f8f9fa;
        }
        .container { 
            background: white;
            border-radius: 8px; 
            padding: 20px; 
            margin: 15px 0; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .success { border-left: 5px solid #28a745; background: #f0fff4; }
        .error { border-left: 5px solid #dc3545; background: #fff5f5; }
        .info { border-left: 5px solid #17a2b8; background: #e6f7ff; }
        .warning { border-left: 5px solid #ffc107; background: #fffbf0; }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        button.success { background: #28a745; }
        button.success:hover { background: #1e7e34; }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        
        .test-result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .scenario {
            background: #2d3748;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-family: monospace;
            font-size: 11px;
        }
        
        .detection-result {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-weight: bold;
        }
        .detection-result.success { background: #d4edda; color: #155724; }
        .detection-result.failure { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>üß™ Teste de L√≥gica de Detec√ß√£o Melhorada</h1>
    
    <div class="container info">
        <h2>üìã Objetivo</h2>
        <p>Este teste simula diferentes formatos de resposta da Evolution API v2 para validar se nossa nova l√≥gica de detec√ß√£o de sucesso funciona corretamente em todos os cen√°rios.</p>
    </div>

    <div class="container">
        <h3>üéØ Testes de Valida√ß√£o</h3>
        <button onclick="runAllTests()" class="success">‚ñ∂Ô∏è Executar Todos os Testes</button>
        <button onclick="runSuccessTests()">‚úÖ Apenas Cen√°rios de Sucesso</button>
        <button onclick="runFailureTests()">‚ùå Apenas Cen√°rios de Falha</button>
        <button onclick="clearResults()" class="danger">üóëÔ∏è Limpar Resultados</button>
    </div>

    <div class="container">
        <h3>üìä Resultados dos Testes</h3>
        <div id="testResults">Clique em "Executar Todos os Testes" para come√ßar...</div>
    </div>

    <script>
        // NOVA L√ìGICA DE DETEC√á√ÉO - Replicada do c√≥digo real
        function enhancedSuccessDetection(stateData) {
            // Extrair m√∫ltiplas fontes de informa√ß√£o de estado
            const connectionState = stateData?.instance?.state || stateData?.state || stateData?.status;
            const alternativeState = stateData?.instance?.status || stateData?.connectionStatus || stateData?.connection?.state;
            const isInstanceConnected = stateData?.instance?.isConnected === true;
            const hasUserInfo = !!(stateData?.instance?.user?.id || stateData?.user?.id);
            
            // M√∫ltiplas condi√ß√µes de detec√ß√£o de sucesso
            const isConnectedByState = connectionState === "open" || connectionState === "connected" || connectionState === "confirmed";
            const isConnectedByAltState = alternativeState === "open" || alternativeState === "connected" || alternativeState === "confirmed";
            const isConnectedByFlag = isInstanceConnected === true;
            const isConnectedByUserPresence = hasUserInfo && (connectionState !== "close" && connectionState !== "disconnected");
            
            const isConnected = isConnectedByState || isConnectedByAltState || isConnectedByFlag || isConnectedByUserPresence;
            
            // Retornar detalhes para an√°lise
            return {
                isConnected,
                reasons: {
                    byState: isConnectedByState,
                    byAltState: isConnectedByAltState, 
                    byFlag: isConnectedByFlag,
                    byUserPresence: isConnectedByUserPresence
                },
                extractedData: {
                    connectionState,
                    alternativeState,
                    isInstanceConnected,
                    hasUserInfo
                }
            };
        }

        // L√ìGICA ANTIGA - Para compara√ß√£o
        function oldSuccessDetection(stateData) {
            const connectionState = stateData?.instance?.state || stateData?.state || stateData?.status;
            const isConnected = connectionState === "open" || connectionState === "connected" || connectionState === "confirmed";
            
            return {
                isConnected,
                extractedState: connectionState
            };
        }

        // CEN√ÅRIOS DE TESTE
        const testScenarios = [
            // ‚úÖ CEN√ÅRIOS DE SUCESSO
            {
                name: "Evolution API v2 - Estado Open",
                description: "Formato padr√£o da Evolution API v2 com state=open",
                data: { instance: { instanceName: "test-123", state: "open" } },
                expectedResult: true,
                category: "success"
            },
            {
                name: "Estado Connected no Status",
                description: "Usando campo de status alternativo",
                data: { instance: { instanceName: "test-123", status: "connected" } },
                expectedResult: true,
                category: "success"
            },
            {
                name: "Flag isConnected=true",
                description: "Usando flag booleana de conex√£o",
                data: { instance: { isConnected: true, state: "loading" } },
                expectedResult: true,
                category: "success"
            },
            {
                name: "Usu√°rio Presente + Estado V√°lido",
                description: "Detecta sucesso pela presen√ßa de informa√ß√µes do usu√°rio",
                data: { 
                    instance: { 
                        state: "loading",
                        user: { id: "5511987654321@c.us", name: "Jo√£o" }
                    }
                },
                expectedResult: true,
                category: "success"
            },
            {
                name: "ConnectionStatus Open",
                description: "Estado em campo connectionStatus",
                data: { connectionStatus: "open", instance: { instanceName: "test" } },
                expectedResult: true,
                category: "success"
            },
            {
                name: "Estado Confirmed",
                description: "Varia√ß√£o com state=confirmed",
                data: { instance: { state: "confirmed" } },
                expectedResult: true,
                category: "success"
            },
            {
                name: "M√∫ltiplos Indicadores",
                description: "V√°rios indicadores de sucesso presentes",
                data: { 
                    instance: { 
                        state: "open", 
                        status: "connected",
                        isConnected: true,
                        user: { id: "123@c.us" }
                    }
                },
                expectedResult: true,
                category: "success"
            },

            // ‚ùå CEN√ÅRIOS DE FALHA
            {
                name: "Estado Close",
                description: "Conex√£o fechada",
                data: { instance: { state: "close" } },
                expectedResult: false,
                category: "failure"
            },
            {
                name: "Estado Disconnected",
                description: "Desconectado",
                data: { instance: { state: "disconnected" } },
                expectedResult: false,
                category: "failure"
            },
            {
                name: "Estado Loading",
                description: "Ainda carregando, sem usu√°rio",
                data: { instance: { state: "loading" } },
                expectedResult: false,
                category: "failure"
            },
            {
                name: "Usu√°rio Presente mas Estado Close",
                description: "Usu√°rio presente mas conex√£o fechada",
                data: { 
                    instance: { 
                        state: "close",
                        user: { id: "123@c.us" }
                    }
                },
                expectedResult: false,
                category: "failure"
            },
            {
                name: "Resposta Vazia",
                description: "API retorna objeto vazio",
                data: {},
                expectedResult: false,
                category: "failure"
            },
            {
                name: "Apenas InstanceName",
                description: "S√≥ tem nome da inst√¢ncia, sem estado",
                data: { instance: { instanceName: "test-123" } },
                expectedResult: false,
                category: "failure"
            }
        ];

        function runTest(scenario) {
            const newResult = enhancedSuccessDetection(scenario.data);
            const oldResult = oldSuccessDetection(scenario.data);
            
            const isCorrect = newResult.isConnected === scenario.expectedResult;
            const improved = oldResult.isConnected !== scenario.expectedResult && newResult.isConnected === scenario.expectedResult;
            
            return {
                scenario,
                newResult,
                oldResult,
                isCorrect,
                improved
            };
        }

        function runAllTests() {
            console.log("üß™ Executando todos os testes de detec√ß√£o...");
            
            const results = testScenarios.map(runTest);
            displayResults(results);
            
            // Estat√≠sticas
            const correct = results.filter(r => r.isCorrect).length;
            const improved = results.filter(r => r.improved).length;
            const total = results.length;
            
            console.log(`üìä Resultados: ${correct}/${total} corretos, ${improved} melhorias`);
        }

        function runSuccessTests() {
            const successScenarios = testScenarios.filter(s => s.category === "success");
            const results = successScenarios.map(runTest);
            displayResults(results);
        }

        function runFailureTests() {
            const failureScenarios = testScenarios.filter(s => s.category === "failure");
            const results = failureScenarios.map(runTest);
            displayResults(results);
        }

        function displayResults(results) {
            const container = document.getElementById('testResults');
            let html = '';
            
            let correctCount = 0;
            let improvedCount = 0;
            
            results.forEach((result, index) => {
                const { scenario, newResult, oldResult, isCorrect, improved } = result;
                
                if (isCorrect) correctCount++;
                if (improved) improvedCount++;
                
                const statusClass = isCorrect ? 'success' : 'failure';
                const statusIcon = isCorrect ? '‚úÖ' : '‚ùå';
                const improvedIcon = improved ? 'üöÄ' : '';
                
                html += `
                    <div class="test-result">
                        <h4>${statusIcon} ${scenario.name} ${improvedIcon}</h4>
                        <p><strong>Descri√ß√£o:</strong> ${scenario.description}</p>
                        
                        <div class="scenario">
                            <strong>Dados de entrada:</strong><br>
                            ${JSON.stringify(scenario.data, null, 2)}
                        </div>
                        
                        <div class="detection-result ${statusClass}">
                            <strong>Resultado:</strong> ${newResult.isConnected ? 'CONECTADO' : 'N√ÉO CONECTADO'} 
                            (Esperado: ${scenario.expectedResult ? 'CONECTADO' : 'N√ÉO CONECTADO'})
                        </div>
                        
                        ${newResult.isConnected ? `
                            <div style="background: #e6f7ff; padding: 8px; border-radius: 4px; margin: 5px 0;">
                                <strong>Raz√µes da detec√ß√£o:</strong><br>
                                ${Object.entries(newResult.reasons)
                                    .filter(([key, value]) => value)
                                    .map(([key, value]) => `‚Ä¢ ${key}: ${value}`)
                                    .join('<br>') || 'Nenhuma raz√£o identificada'}
                            </div>
                        ` : ''}
                        
                        <details style="margin-top: 10px;">
                            <summary>üîç Detalhes T√©cnicos</summary>
                            <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px;">
                                <strong>Nova L√≥gica:</strong><br>
                                ${JSON.stringify(newResult.extractedData, null, 2)}<br><br>
                                <strong>L√≥gica Antiga:</strong><br>
                                Estado extra√≠do: "${oldResult.extractedState}" ‚Üí ${oldResult.isConnected ? 'CONECTADO' : 'N√ÉO CONECTADO'}
                            </div>
                        </details>
                    </div>
                `;
            });
            
            // Resumo
            html = `
                <div class="container ${correctCount === results.length ? 'success' : 'warning'}">
                    <h3>üìä Resumo dos Testes</h3>
                    <p><strong>Corretos:</strong> ${correctCount}/${results.length}</p>
                    <p><strong>Melhorias:</strong> ${improvedCount} cen√°rios agora detectados corretamente</p>
                    <p><strong>Taxa de Sucesso:</strong> ${Math.round((correctCount/results.length)*100)}%</p>
                </div>
            ` + html;
            
            container.innerHTML = html;
        }

        function clearResults() {
            document.getElementById('testResults').innerHTML = 'Clique em "Executar Todos os Testes" para come√ßar...';
        }

        // Inicializa√ß√£o
        console.log("üß™ Sistema de testes carregado");
        console.log(`üìã ${testScenarios.length} cen√°rios de teste dispon√≠veis`);
    </script>
</body>
</html>
