<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® EMERGENCY DEBUG - Loop Infinito Ativo</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 0;
            padding: 20px;
            background: #000;
            color: #00ff00;
            line-height: 1.4;
        }
        .emergency-header {
            background: #ff0000;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            font-size: 18px;
            border-radius: 5px;
            margin-bottom: 20px;
            animation: blink 1s infinite;
        }
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        .debug-section {
            background: #001100;
            border: 2px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .critical {
            border-color: #ff0000;
            background: #330000;
            color: #ff6666;
        }
        .request-monitor {
            max-height: 300px;
            overflow-y: auto;
            background: #000033;
            padding: 10px;
            border: 1px solid #0066ff;
            font-size: 11px;
        }
        button {
            background: #ff0000;
            color: #fff;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background: #cc0000; }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 20px 0;
        }
        .metric {
            background: #001122;
            padding: 15px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid #0088ff;
        }
        .metric-value {
            font-size: 28px;
            font-weight: bold;
            color: #ff6600;
        }
        .metric-label {
            font-size: 12px;
            color: #cccccc;
            margin-top: 5px;
        }
        .danger {
            color: #ff0000;
            animation: blink 1s infinite;
        }
    </style>
</head>
<body>
    <div class="emergency-header">
        üö® EMERGENCY DEBUG MODE - LOOP INFINITO DETECTADO üö®
    </div>

    <div class="debug-section critical">
        <h2>üî• SITUA√á√ÉO CR√çTICA</h2>
        <p><strong>PROBLEMA:</strong> Loop infinito voltou e est√° pior que antes</p>
        <p><strong>SINTOMAS:</strong> Sistema travou, dados salvam mas n√£o aparecem no dashboard</p>
        <p><strong>A√á√ÉO:</strong> Debug em tempo real ativo</p>
    </div>

    <div class="status-grid">
        <div class="metric">
            <div class="metric-value danger" id="requestCount">0</div>
            <div class="metric-label">Requests Detectadas</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="errorCount">0</div>
            <div class="metric-label">Erros 404/500</div>
        </div>
        <div class="metric">
            <div class="metric-value" id="duration">0s</div>
            <div class="metric-label">Tempo Monitorando</div>
        </div>
    </div>

    <div class="debug-section">
        <h3>üîç A√ß√µes de Emerg√™ncia</h3>
        <button onclick="startEmergencyMonitoring()">üö® INICIAR MONITOR EMERGENCIAL</button>
        <button onclick="forceStopAllPolling()">üõë FORCE STOP POLLING</button>
        <button onclick="killAllIntervals()">üíÄ KILL ALL INTERVALS</button>
        <button onclick="clearLogs()">üßπ Limpar Logs</button>
    </div>

    <div class="debug-section">
        <h3>üìä Log de Requests em Tempo Real</h3>
        <div class="request-monitor" id="requestLog">
            Aguardando in√≠cio do monitoramento...
        </div>
    </div>

    <div class="debug-section">
        <h3>üîß Diagn√≥stico R√°pido</h3>
        <button onclick="testDashboardAPI()">üìä Testar API Dashboard</button>
        <button onclick="testWhatsAppAPI()">üì± Testar API WhatsApp</button>
        <button onclick="checkActiveTimers()">üîÑ Ver Timers Ativos</button>
        <button onclick="inspectPollingHooks()">üîç Inspecionar Hooks</button>
    </div>

    <div class="debug-section critical">
        <h3>‚ö†Ô∏è Resultados de Diagn√≥stico</h3>
        <div id="diagnosticResults" style="font-family: monospace; font-size: 12px;">
            Nenhum teste executado ainda...
        </div>
    </div>

    <script>
        let monitoringActive = false;
        let requestCount = 0;
        let errorCount = 0;
        let startTime = null;
        let monitorInterval = null;
        let originalFetch = null;

        function log(message, type = 'info') {
            const logArea = document.getElementById('requestLog');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : 
                          type === 'warning' ? '‚ö†Ô∏è' : 
                          type === 'critical' ? 'üö®' : 
                          type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            logArea.innerHTML += `<div>[${timestamp}] ${prefix} ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function logDiagnostic(message) {
            const diagnosticArea = document.getElementById('diagnosticResults');
            const timestamp = new Date().toLocaleTimeString();
            diagnosticArea.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        }

        function updateMetrics() {
            document.getElementById('requestCount').textContent = requestCount;
            document.getElementById('errorCount').textContent = errorCount;
            
            if (startTime) {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('duration').textContent = elapsed + 's';
            }
        }

        function startEmergencyMonitoring() {
            if (monitoringActive) {
                log('Monitor j√° est√° ativo!', 'warning');
                return;
            }

            monitoringActive = true;
            startTime = Date.now();
            requestCount = 0;
            errorCount = 0;

            log('üö® EMERGENCY MONITORING INICIADO', 'critical');
            
            // Salvar fetch original se ainda n√£o foi salvo
            if (!originalFetch) {
                originalFetch = window.fetch;
            }

            // Interceptar fetch requests
            window.fetch = function(...args) {
                requestCount++;
                const url = args[0];
                log(`üì° REQUEST: ${url}`, 'info');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        if (!response.ok) {
                            errorCount++;
                            log(`‚ùå ERROR ${response.status}: ${url}`, 'error');
                        } else {
                            log(`‚úÖ SUCCESS ${response.status}: ${url}`, 'success');
                        }
                        updateMetrics();
                        return response;
                    })
                    .catch(error => {
                        errorCount++;
                        log(`üö® FETCH ERROR: ${error.message} - ${url}`, 'critical');
                        updateMetrics();
                        throw error;
                    });
            };

            // Monitor peri√≥dico
            monitorInterval = setInterval(() => {
                updateMetrics();
                
                // Alerta se muitas requests
                if (requestCount > 30) {
                    log(`üö® ALERTA: ${requestCount} requests detectadas - LOOP INFINITO CONFIRMADO!`, 'critical');
                }
            }, 1000);

            log('Monitor ativo - interceptando requests...', 'success');
        }

        function forceStopAllPolling() {
            log('üõë FORCE STOPPING ALL POLLING...', 'critical');
            
            // Restaurar fetch original
            if (originalFetch) {
                window.fetch = originalFetch;
                log('‚úÖ Fetch original restaurado', 'success');
            }
            
            // Parar monitoring
            monitoringActive = false;
            if (monitorInterval) {
                clearInterval(monitorInterval);
                monitorInterval = null;
            }
            
            killAllIntervals();
        }

        function killAllIntervals() {
            log('üíÄ KILLING ALL TIMERS/INTERVALS...', 'critical');
            
            // Obter o ID mais alto
            const highestId = setTimeout(() => {}, 1);
            let killedCount = 0;
            
            // Limpar todos os timers/intervals
            for (let i = 1; i < highestId; i++) {
                try {
                    clearTimeout(i);
                    clearInterval(i);
                    killedCount++;
                } catch (e) {
                    // Ignorar erros
                }
            }
            
            log(`‚úÖ ${killedCount} timers/intervals eliminados`, 'success');
            logDiagnostic(`üíÄ Eliminados ${killedCount} timers (IDs 1-${highestId})`);
        }

        function checkActiveTimers() {
            log('üîç Verificando timers ativos...', 'info');
            
            const highestId = setTimeout(() => {}, 1) - 1;
            logDiagnostic(`üîç Highest timer ID: ${highestId}`);
            
            if (highestId > 200) {
                logDiagnostic(`üö® CR√çTICO: ${highestId} timers - LOOP INFINITO ATIVO!`);
            } else if (highestId > 50) {
                logDiagnostic(`‚ö†Ô∏è SUSPEITO: ${highestId} timers - poss√≠vel leak`);
            } else {
                logDiagnostic(`‚úÖ Normal: ${highestId} timers`);
            }
        }

        async function testDashboardAPI() {
            log('üß™ Testando API do Dashboard...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/api/usage-stats', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    logDiagnostic(`‚úÖ Dashboard API OK - ${JSON.stringify(data).substring(0, 100)}...`);
                } else {
                    logDiagnostic(`‚ùå Dashboard API Error: ${response.status}`);
                }
            } catch (error) {
                logDiagnostic(`üö® Dashboard API Failed: ${error.message}`);
            }
        }

        async function testWhatsAppAPI() {
            log('üß™ Testando API do WhatsApp...', 'info');
            
            try {
                const response = await fetch('http://localhost:8080/api/evolution/status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instanceName: 'debug-test' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    logDiagnostic(`‚úÖ WhatsApp API OK - ${JSON.stringify(data).substring(0, 100)}...`);
                } else {
                    logDiagnostic(`‚ùå WhatsApp API Error: ${response.status}`);
                }
            } catch (error) {
                logDiagnostic(`üö® WhatsApp API Failed: ${error.message}`);
            }
        }

        function inspectPollingHooks() {
            log('üîç Inspecionando hooks de polling...', 'info');
            
            // Verificar se React DevTools est√° dispon√≠vel
            if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {
                logDiagnostic('‚úÖ React DevTools detectado');
                
                // Tentar encontrar componentes com polling
                const hook = window.__REACT_DEVTOOLS_GLOBAL_HOOK__;
                if (hook.renderers) {
                    logDiagnostic(`üîç ${hook.renderers.size} React renderers encontrados`);
                }
            } else {
                logDiagnostic('‚ùå React DevTools n√£o encontrado');
            }
            
            // Verificar vari√°veis globais do React
            if (window.React) {
                logDiagnostic('‚úÖ React global encontrado');
            }
        }

        function clearLogs() {
            document.getElementById('requestLog').innerHTML = 'Logs limpos...<br>';
            document.getElementById('diagnosticResults').innerHTML = 'Diagn√≥sticos limpos...<br>';
        }

        // Auto-start on load
        window.onload = function() {
            log('üö® EMERGENCY DEBUG TOOL CARREGADO', 'critical');
            log('Sistema travou - iniciando monitoramento autom√°tico...', 'warning');
            
            // Auto-start monitoring ap√≥s 2 segundos
            setTimeout(() => {
                startEmergencyMonitoring();
                checkActiveTimers();
            }, 2000);
        };
    </script>
</body>
</html>