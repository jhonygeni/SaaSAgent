<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Teste Webhook Disable - CorreÃ§Ãµes Aplicadas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .status {
            padding: 12px 20px;
            border-radius: 6px;
            margin: 15px 0;
            font-weight: bold;
            text-align: center;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:disabled { background: #6c757d; cursor: not-allowed; transform: none; }
        .log {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
        }
        .fixes-applied {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ”§ Teste Webhook Disable - CorreÃ§Ãµes Aplicadas</h1>
        <p>Testando as correÃ§Ãµes para resolver erros 400 e 500 no toggle de agentes</p>
    </div>

    <div class="fixes-applied">
        <h2>âœ… CorreÃ§Ãµes Implementadas</h2>
        <ul>
            <li><strong>Formato de Dados:</strong> Evolution API V2 agora recebe dados no formato {"webhook": {...}}</li>
            <li><strong>ValidaÃ§Ã£o de Entrada:</strong> Adicionada validaÃ§Ã£o para instanceName</li>
            <li><strong>Logs Melhorados:</strong> Debug detalhado para troubleshooting</li>
            <li><strong>Tratamento de Erro:</strong> Melhor handling de respostas da Evolution API</li>
            <li><strong>API Route Corrigida:</strong> Vercel webhook route formatando dados corretamente</li>
            <li><strong>Edge Function OK:</strong> Supabase Edge Function jÃ¡ estava correta</li>
        </ul>
    </div>

    <div class="container">
        <h2>ğŸ¯ ConfiguraÃ§Ã£o do Teste</h2>
        <label for="instanceName">Nome da InstÃ¢ncia:</label>
        <input type="text" id="instanceName" value="inst_test_webhook_fix" placeholder="Digite o nome da instÃ¢ncia">
        
        <div class="info">
            <strong>Ambiente:</strong> <span id="environment">Detectando...</span><br>
            <strong>Endpoint:</strong> <span id="endpoint">Determinando...</span>
        </div>
    </div>

    <div class="test-grid">
        <div class="test-card">
            <h3>1. ğŸ” Verificar Webhook Atual</h3>
            <button onclick="testCheckWebhook()">Verificar Webhook</button>
            <div id="checkStatus" class="status info">Aguardando...</div>
        </div>

        <div class="test-card">
            <h3>2. âœ… Habilitar Webhook</h3>
            <button onclick="testEnableWebhook()">Habilitar Webhook</button>
            <div id="enableStatus" class="status info">Aguardando...</div>
        </div>

        <div class="test-card">
            <h3>3. ğŸš« Desabilitar Webhook</h3>
            <button onclick="testDisableWebhook()">Desabilitar Webhook (CORREÃ‡ÃƒO)</button>
            <div id="disableStatus" class="status info">Aguardando...</div>
        </div>

        <div class="test-card">
            <h3>4. ğŸ”„ Toggle Agent Status</h3>
            <button onclick="testAgentToggle()">Simular Toggle de Agente</button>
            <div id="toggleStatus" class="status info">Aguardando...</div>
        </div>
    </div>

    <div class="container">
        <h2>ğŸ“Š Log de Testes</h2>
        <button onclick="clearLog()">ğŸ—‘ï¸ Limpar Log</button>
        <div id="log" class="log">ğŸ”§ Sistema carregado. Pronto para testar as correÃ§Ãµes...\n</div>
    </div>

    <script>
        const baseUrl = window.location.origin;
        
        // Detectar ambiente
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const isDev = window.location.port === '3000';
        
        document.getElementById('environment').textContent = isLocal && isDev ? 'Desenvolvimento (Local)' : 'ProduÃ§Ã£o';
        document.getElementById('endpoint').textContent = isLocal && isDev ? 'Supabase Edge Function' : 'Vercel API Routes';

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const emoji = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logDiv.textContent += `[${timestamp}] ${emoji} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function setStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = `status ${type}`;
        }

        function clearLog() {
            document.getElementById('log').textContent = 'ğŸ—‘ï¸ Log limpo. Pronto para novos testes...\n';
        }

        function getInstanceName() {
            const name = document.getElementById('instanceName').value.trim();
            if (!name) {
                throw new Error('Nome da instÃ¢ncia Ã© obrigatÃ³rio');
            }
            return name;
        }

        async function testCheckWebhook() {
            try {
                const instanceName = getInstanceName();
                log(`ğŸ” Verificando webhook atual para: ${instanceName}`);
                setStatus('checkStatus', 'Verificando...', 'info');
                
                const response = await fetch(`${baseUrl}/api/evolution/webhook?instance=${encodeURIComponent(instanceName)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                log(`ğŸ“¥ Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Webhook encontrado: ${JSON.stringify(data, null, 2)}`);
                    setStatus('checkStatus', 'âœ… Webhook verificado', 'success');
                } else {
                    const errorText = await response.text();
                    log(`âŒ Erro: ${errorText}`, 'error');
                    setStatus('checkStatus', `âŒ Erro ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Erro: ${error.message}`, 'error');
                setStatus('checkStatus', 'âŒ Erro de rede', 'error');
            }
        }

        async function testEnableWebhook() {
            try {
                const instanceName = getInstanceName();
                log(`âœ… Habilitando webhook para: ${instanceName}`);
                setStatus('enableStatus', 'Habilitando...', 'info');
                
                const webhookConfig = {
                    url: "https://webhooksaas.geni.chat/webhook/principal",
                    enabled: true,
                    webhook_by_events: true,
                    webhook_base64: true,
                    events: ["MESSAGES_UPSERT"]
                };
                
                log(`ğŸ“‹ Config a enviar: ${JSON.stringify(webhookConfig, null, 2)}`);
                
                const response = await fetch(`${baseUrl}/api/evolution/webhook?instance=${encodeURIComponent(instanceName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookConfig)
                });
                
                log(`ğŸ“¥ Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… Webhook habilitado: ${JSON.stringify(data, null, 2)}`);
                    setStatus('enableStatus', 'âœ… Webhook habilitado', 'success');
                } else {
                    const errorText = await response.text();
                    log(`âŒ Erro: ${errorText}`, 'error');
                    setStatus('enableStatus', `âŒ Erro ${response.status}`, 'error');
                }
            } catch (error) {
                log(`âŒ Erro: ${error.message}`, 'error');
                setStatus('enableStatus', 'âŒ Erro de rede', 'error');
            }
        }

        async function testDisableWebhook() {
            try {
                const instanceName = getInstanceName();
                log(`ğŸš« TESTANDO CORREÃ‡ÃƒO: Desabilitando webhook para: ${instanceName}`);
                setStatus('disableStatus', 'Desabilitando...', 'info');
                
                // NOVO FORMATO CORRIGIDO
                const webhookConfig = {
                    url: "",
                    enabled: false,
                    webhook_by_events: false,
                    webhook_base64: false,
                    events: []
                };
                
                log(`ğŸ“‹ Config CORRIGIDO a enviar: ${JSON.stringify(webhookConfig, null, 2)}`);
                log(`ğŸ”§ API Route irÃ¡ formatar como: {"webhook": ${JSON.stringify(webhookConfig, null, 2)}}`);
                
                const response = await fetch(`${baseUrl}/api/evolution/webhook?instance=${encodeURIComponent(instanceName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(webhookConfig)
                });
                
                log(`ğŸ“¥ Response: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const data = await response.json();
                    log(`âœ… SUCESSO! Webhook desabilitado: ${JSON.stringify(data, null, 2)}`, 'success');
                    setStatus('disableStatus', 'âœ… Webhook desabilitado', 'success');
                } else {
                    const errorText = await response.text();
                    log(`âŒ FALHA: ${errorText}`, 'error');
                    setStatus('disableStatus', `âŒ Erro ${response.status}`, 'error');
                    
                    // Tentar parse do erro
                    try {
                        const errorData = JSON.parse(errorText);
                        log(`ğŸ“‹ Detalhes do erro: ${JSON.stringify(errorData, null, 2)}`, 'error');
                    } catch (e) {
                        log(`ğŸ“‹ Erro nÃ£o Ã© JSON vÃ¡lido: ${errorText}`, 'error');
                    }
                }
            } catch (error) {
                log(`âŒ Erro: ${error.message}`, 'error');
                setStatus('disableStatus', 'âŒ Erro de rede', 'error');
            }
        }

        async function testAgentToggle() {
            try {
                log(`ğŸ”„ Simulando toggle de agente (enable â†’ disable â†’ enable)`);
                setStatus('toggleStatus', 'Testando toggle...', 'info');
                
                // Simular sequÃªncia completa
                await testEnableWebhook();
                await new Promise(resolve => //DISABLED setTimeout(resolve, 1000)); // Aguardar 1s
                await testDisableWebhook();
                await new Promise(resolve => //DISABLED setTimeout(resolve, 1000)); // Aguardar 1s
                await testEnableWebhook();
                
                log(`âœ… Teste de toggle completo!`, 'success');
                setStatus('toggleStatus', 'âœ… Toggle testado', 'success');
                
            } catch (error) {
                log(`âŒ Erro no toggle: ${error.message}`, 'error');
                setStatus('toggleStatus', 'âŒ Erro no toggle', 'error');
            }
        }

        // InicializaÃ§Ã£o
        window.addEventListener('load', () => {
            log('ğŸ”§ Teste de correÃ§Ãµes carregado');
            log('ğŸ“‹ Verificar console do navegador para logs detalhados');
            
            // Mostrar informaÃ§Ãµes do ambiente
            log(`ğŸŒ Ambiente: ${isLocal && isDev ? 'Desenvolvimento' : 'ProduÃ§Ã£o'}`);
            log(`ğŸ”— Base URL: ${baseUrl}`);
        });
    </script>
</body>
</html>
